\documentclass[border=1cm]{standalone}

\usepackage{tikz}
\usetikzlibrary{shapes.geometric, shapes.misc}
\usetikzlibrary{cd, fit, calc}
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.markings}
\usepackage{medl_colors}
\usepackage{fontspec}

\usepackage{arrayjob}
\def\words{{
    {"We","enjoyed","writing", "this", "book"},
    {"Nous","avons","aimé", "écrire", "ce", "livre", "<end>"},
    {"<start>", "Nous","avons","aimé", "écrire", "ce", "livre"}
}}

\pgfdeclarelayer{background}
\pgfsetlayers{background, main}

\newcommand\rnnunit[7]
{
    \foreach \i in {1,...,#4}
    {
        \pgfmathparse{int(\i-1)}\edef\j{\pgfmathresult};
        \pgfmathparse{\words[#5][\j]} \edef\topword{\pgfmathresult};
        \pgfmathparse{\words[#6][\j]} \edef\bottomword{\pgfmathresult};
        
        \node[draw, rounded corners, minimum width=1cm, minimum height=1cm, fill=fblue] (unit\i#1) at (#2+\j*2, #3) { unit };
        \node[below of=unit\i#1, node distance= 2cm] (bottom\i-#1) {\texttt{ \bottomword} };
        \draw[-Triangle] (bottom\i-#1) -- (unit\i#1);

        \ifnum#7>1
            \node[above of=unit\i#1, node distance= 2cm] (top\i-#1) { \texttt{ \topword }};
            \draw[Triangle-] (top\i-#1) -- (unit\i#1);  
            \ifnum\i>1
                \draw[-Triangle,thick, bend right, looseness=1] (top\j-#1.east) to[out=90, in=-90] ([xshift=-6mm]bottom\i-#1);
            \fi
        \fi
        
        \ifnum\i>1
            \draw[-Triangle] (unit\j#1) -- (unit\i#1); 
        \fi
    }       
}

\newcommand\fullthing[3]
{
    \rnnunit{a#1}{0}{#2}{5}{0}{0}{1};
    \node[draw, fill=green1, rounded corners, minimum width=.5cm, minimum height=3cm, right of=unit5a#1, node distance=2cm] (block#1) {};
    \node[rotate=90, below of=block#1, node distance=0cm] {Coding Features};
    \rnnunit{b#1}{12}{#2}{7}{1}{2}{2};
    \draw[-Triangle] (unit5a#1) -- (block#1);
    \draw[-Triangle] (block#1) -- (unit1b#1) node[pos=.4, above]{\Large #3};
    \begin{pgfonlayer}{background}
        \node [rounded corners, draw, fill=fgreen, minimum width=9.5cm, minimum height=2.5cm, below of=unit3a#1, node distance=0cm] (rect1#1)  {};
        \node [rounded corners, draw, fill=redlight, minimum width=13.5cm, minimum height=2.5cm, below of=unit4b#1, node distance=0cm] (rect2#1)  {};
        \node [rounded corners, black!50, minimum width=9.5cm, minimum height=7cm, below of=unit3a#1, node distance=.5cm] (rect3#1)  {};
        \node [rounded corners, black!50, minimum width=13.5cm, minimum height=8cm, below of=unit4b#1, node distance=0cm] (rect4#1)  {};
    \end{pgfonlayer}
    
    \node [above of=rect3#1, node distance=3cm] { Encoder };
    \node [below of=rect4#1, node distance=3.5cm] { Decoder };

    \node [below of=rect1#1, node distance=2.8cm] { Input: Source Sentence} ;
    \node [above of=rect2#1, node distance=3cm] { Output: Source Sentence};

    \draw ([xshift=2mm, yshift=2.2cm]rect2#1.west) -- ([xshift=2mm, yshift=2.5cm]rect2#1.west) -- ([xshift=-2mm, yshift=2.5cm]rect2#1.east) -- ([xshift=-2mm, yshift=2.2cm]rect2#1.east) ;
    \draw ([xshift=2mm, yshift=-2cm]rect1#1.west) -- ([xshift=2mm, yshift=-2.3cm]rect1#1.west) -- ([xshift=-2mm, yshift=-2.3cm]rect1#1.east) -- ([xshift=-2mm, yshift=-2cm]rect1#1.east) ;
}



\begin{document}
\begin{tikzpicture}

\fullthing{2}{10}{$z^*$};

\end{tikzpicture}
\end{document}
