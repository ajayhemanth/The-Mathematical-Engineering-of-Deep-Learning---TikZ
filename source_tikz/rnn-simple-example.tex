\documentclass[border=1cm]{standalone}

\usepackage{tikz}
\usetikzlibrary{shapes.geometric, shapes.misc}
\usetikzlibrary{cd, fit, calc}
\usetikzlibrary{positioning}
\usetikzlibrary{decorations.markings}
\usepackage{medl_colors}
\usepackage{graphicx} %package to manage images
\graphicspath{ {./images/} } 

\usepackage{arrayjob}

\begin{document}
\begin{tikzpicture}

\pgfdeclarelayer{background}
\pgfsetlayers{background, main}

\def\numsA{{
        {"-2.3", "-0.5", "1.1", "2.2", "1.2", "1.9"}, 
        {"0.3", "1.3", "-1.2", "0.7", "-1.1", "0.2"}, 
        {"-0.3", "-1.1", "1.4", "-0.5", "1.5", "0.2"}, 
        {"1.2", "1.7", "0.3", "0.5", "-0.7", "1.3"}, 
        {"-0.3", "1.1", "2.4", "-0.6", "0.9", "1.2"}
}};

\def\numsB{{
        {"0", "0", "0", "0", "0", "1"}, 
        {"0", "0", "0", "1", "0", "0"}, 
        {"0", "1", "0", "0", "0", "0"}, 
        {"0", "0", "0", "0", "1", "0"}, 
        {"1", "0", "0", "0", "0", "0"} 
}};

\def\spec{{
        {"The", "Mathematical", "Engineering", "of", "Deep"},
        {"Mathematical", "Engineering", "of", "Engineering", "Learning"},
        {"Mathematical", "Engineering", "of", "Deep", "Learning"},
        {"Deep", "Engineering", "Learning", "Mathematical", "of", "The"}, 
        {"3", "1", "4", "1", "2", "3"}
}};

\node[draw, fill=fred, rounded corners, minimum width=9cm, minimum height=.5cm] at (4,5) (rect1) {};
\node[draw, fill=fyellow, rounded corners, minimum width=9cm, minimum height=.5cm] at (4,4.2) (rect2) {};
\node[draw, fill=fblue, rounded corners, minimum width=9cm, minimum height=.5cm] at (4,-4) (rect3) {};

\foreach \i in {1,...,5}
{
       \pgfmathparse{\i-1}\edef\j{\pgfmathresult};

        \node[draw, fill=blue1, rounded corners, minimum width=1cm, minimum height=.5cm] (unit\i) at (\i*1.5, 0) { \tiny $h^{\langle \i \rangle}$};

        \node[draw, fill=pink1, rounded corners, minimum width=.5cm, minimum height=2cm, above of=unit\i, node distance=2.5cm] (top\i) { };
        
        \draw[-Triangle, draw=black!50] (unit\i) -- (top\i) node[midway,left] {\tiny $W_{yh}$};
        
        \node[draw, fill=green1, rounded corners, minimum width=.5cm, minimum height=2cm, below of=unit\i, node distance=2.5cm] (bottom\i) { };
        \draw[Triangle-, draw=black!50] (unit\i) -- (bottom\i) node[midway,left] {\tiny $W_{hx}$};;
        
        \ifnum\i>1
            \draw[-Triangle, draw=black!50] (unit\j) -- (unit\i);
        \fi

        \pgfmathparse{\spec[0][\j]} \edef\bword{\pgfmathresult};
        \pgfmathparse{\spec[1][\j]} \edef\tword{\pgfmathresult};
        \pgfmathparse{\spec[2][\j]} \edef\ttword{\pgfmathresult};
        \pgfmathparse{int(\spec[4][\j])} \edef\cindex{\pgfmathresult};

        \node [draw, circle, minimum size=4mm, fill=black!10] at (\i*1.5, 3.3-\cindex*.3) {};
        
        \node[below of=bottom\i, node distance=1.5cm] (bword\i) { \texttt {\tiny \bword}};
        \node[above of=top\i, node distance=1.7cm] (tword\i) { \texttt {\tiny \tword}};
        \node[above of=top\i, node distance=2.5cm] (ttword\i) { \texttt {\tiny \ttword}};          
        \foreach \k in {0,...,5}
        {
            \pgfmathparse{\numsA[\j][\k]} \edef\tnum{\pgfmathresult};
            \pgfmathparse{\numsB[\j][\k]} \edef\ttnum{\pgfmathresult};
            
            \node[] at (\i*1.5, 3.3-\k*.3) (ttext\i\k) { \texttt {\tiny \tnum}};
            \node[] at (\i*1.5, -1.7-\k*.3) (btext\i\k) { \texttt {\tiny \ttnum}};
        }

        \draw[-Triangle, draw=black!50] (bword\i) -- (bottom\i);
        \begin{pgfonlayer}{background}
            \draw[-Triangle, draw=black!50] (top\i) -- (top\i |- rect1.south);
        \end{pgfonlayer}
}

\foreach \k in {0,...,5}
{
    \pgfmathparse{\spec[3][\k]} \edef\ttword{\pgfmathresult};
    \node[align=left, text width=2.2cm] at (0.7, 3.3-\k*.3) (ttext0\k) { \texttt {\tiny  \ttword:}};
    %\draw[-Triangle, draw=black!50] (ttext0\k) -- (ttext1\k);
}

\node[rounded corners, minimum width=1cm, minimum height=.5cm, left of = btext13, node distance=2cm] (encoded) { \tiny One-hot encoded:};
% \draw[-Triangle, draw=black!50] (encoded) -- (bottom1.west |- encoded);
\node[left of = bword1, node distance = 1.4cm] {\tiny Input:};
\node[left of = tword1, node distance = 1.4cm] {\tiny Prediction: };
\node[left of = ttword1, node distance = 1.3cm] {\tiny Target:};

\end{tikzpicture}
\end{document}
